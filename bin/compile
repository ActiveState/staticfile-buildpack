#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -e            # fail fast
set -o pipefail   # don't ignore exit codes when piping output
# set -x          # enable debugging

# Configure directories
build_dir=$1
cache_dir=$2
env_dir=$3

# Version
nginx_version="1.5.10"
# nginx_version="1.7.4"

compile_buildpack_dir=$(cd $(dirname $0); cd ..; pwd)
compile_buildpack_bin=$compile_buildpack_dir/bin

# Load some convenience functions like status(), echo(), and indent()
source $compile_buildpack_dir/bin/common.sh

if [ -d "$env_dir" ]; then
  status "Exporting config vars to environment"
  export_env_dir $env_dir
fi

compile_nginx_tgz="$compile_buildpack_dir/vendor/nginx-$nginx_version.tar.gz"
cd $build_dir

mkdir -p $cache_dir/public
mv * $cache_dir/public
mv $cache_dir/public .
# [[ -f public/Procfile ]] && mv public/Procfile .

tar xzf $compile_nginx_tgz

if [[ "${AUTH}X" != "X" ]]; then
  status "Enabling basic authentication"
  echo $AUTH | indent
  echo
fi
protip "Learn about basic authentication", "https://github.com/drnic/staticfile-buildpack#basic-authentication"


cp -f $compile_buildpack_dir/conf/nginx.conf nginx/conf/nginx.conf
cp -f $compile_buildpack_dir/conf/mime.types nginx/conf/mime.types

[[ -f public/nginx.conf ]] && mv public/nginx.conf nginx/conf/nginx.conf
[[ -f public/mime.types ]] && mv public/mime.types nginx/conf/mime.types

status "nginx.conf"
cat nginx/conf/nginx.conf | indent
echo ""

status "mine.types"
cat nginx/conf/mime.types | indent
echo ""

# echo "-----> Ensuring manifest.yml & stackato.yml aren't available in public/"
# rm -f public/{manifest,stackato}.yml

cp $compile_buildpack_bin/boot.sh .
